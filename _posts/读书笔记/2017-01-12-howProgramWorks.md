---
layout: post
title:  《程序是怎样跑起来的》读书笔记
tags: 读书笔记
---

<img src="/assets/img/howProgramWorks/cover.jpg" style="width:400px;height:400px;margin:0 auto;"/>

* content
{:toc}


### 1：源文件、可执行文件、二进制

  **源文件**：在C和Java等**高级语言**编写的，比如以.c和.java为后缀的文件。
  **可执行文件**：由二进制代码组成，是CPU能直接解析并运行的语言（**机器语言**）。
  
  计算机不能直接理解高级语言，它只能理解机器语言，所以我们必须要把**高级语言**翻译成**机器语言**。也就是**源文件**翻译成**可执行文件**。负责这个翻译过程的程序叫作**编译器**(以及链接器)。
  
  操作系统把可执行文件加载到**内存**中；
  **CPU**执行内存中的程序（执行过程中需要与**磁盘**进行读写交互）
  
  ![](/assets/img/howProgramWorks/run.jpg)

  如果用机器语言编写程序则非常麻烦。一般可以使用**汇编语言**，学习汇编语言能对程序的运行机制有更为深刻的了解。汇编语言和机器语言是一一对应的，其语法是操作码+操作数。不过现在基本上没有人用汇编语言来编写程序了。
  
   **为什么用二进制表示计算机信息：**
   计算机内部都是由IC（集成电路）这种电子部件构成的。IC内部有许多并排排列的引脚，所有引脚只有直流电压的两个状态。虽然二进制数并不是专门为IC设计的，但是和IC的特性非常吻合。
  
### 2：运行环境（操作系统+硬件）
  程序的运行依赖于特定的**运行环境**。

  不同**操作系统**的API有所差异，因此将同样的应用程序移植到其它操作系统时，就必须重写应用中利用到API的部分。像键盘输入、鼠标输入、显示器输出、文件输入输出等都是通过API提供的。
  
  从程序的运行环境这一角度考量硬件时，CPU的种类是特别重要的参数。比如，为了保证Office2007的正常运行，需要x86的CPU。不同种类**CPU**的机器语言不同，比如x86、PowerPC等各自的机器语言完全不同。所以需要利用能够生成各CPU专用的本地代码的编译器，来对源代码进行重新编译。
  
  **windows克服了CPU以外的硬件差异。**早期的MS-DOS时代，不同机型的内存和I/0地址的构成等都是不同的，因此每个机型都需要有专门的MS-DOS应用（应用软件的功能中，存在着直接操作计算机硬件的部分）。而对于windows，同样的应用在任何机型上都是可以运行的，因为windows应用基本上都由windows系统来完成对硬件的控制（程序员就不用注意内存和I/0地址的不同构成了）。不过windows本身则需要为不同机型分别提供专用的版本。
 
  **运行环境（操作系统+CPU）**的不同，导致了可执行文件的不同，所以需要各种不同的编译器，以此来生成不同运行环境下可以运行的可执行文件。
  
  一般确定**编译器**种类的三个关键词：**编程语言、CPU、操作系统**。现在编译器基本上不需要购买，都已经默认集成到开发IDE中了。
  
  ![](/assets/img/howProgramWorks/compile.jpg)
  
  另外，可以使用**虚拟机**来运行其他操作系统的应用。此外，还有java虚拟机保证java程序能在不同操作系统下运行。
  
  **BIOS和引导：**
  运行环境中存在名为BIOS的系统。BIOS存储在ROM中，是预先内置在计算机主机内部的程序。BIOS除了键盘、磁盘、显卡等基本控制程序外，还有启动“引导程序”的功能。
   引导程序是存储在启动驱动器起始区域的小程序，功能是把在硬盘等记录的OS加载到内存中运行。OS并不能自己启动自己，而是通过引导程序来启动。操作系统的启动驱动器一般是硬盘。

### 3：操作系统
 
  在计算机中尚不存在操作系统的年代，完全没有任何程序，因此程序员需要编写出处理相关的所有程序。用机器语言编写程序，然后再使用开关将程序输入，这一过程非常麻烦。于是有人开发出了仅具有加载和运行功能的**监控程序**，这就是操作系统的原型。通过事先启动监控程序，程序员可以根据需要将各种程序加载到内存中运行。
  
  随着时代的发展，人们发现很多程序都有共通的部分。例如，通过键盘输入文字数据、往显示器输出文字数据等。因此，**基本的输入输出部分**的程序就被追加到了监控程序中。
  
  随着时代的进一步发展，开始有更多的功能被追加到监控程序中，比如，为了方便程序员的**硬件控制程序、编程语言处理器（汇编、编译、解析）**以及各种实用程序等，结果就形成了和现在相差不大的操作系统。因此操作系统本身并不是单独的程序，而是多个程序的集合体。
  
  ![](/assets/img/howProgramWorks/os.jpg)
  
  操作系统诞生后，程序员无需再考虑硬件的问题。在操作系统这个运行环境下，应用并不是直接控制硬件，而是通过操作系统来间接控制硬件。操作系统的硬件控制功能，通常是通过一些小的函数集合体的形式来提供的。
  
  这些函数及调用函数的行为统称为**系统调用**。windows通过名为**API**的函数集提供系统调用，比如Win32 API。API通过多个DLL文件来提供。各API的实体都是用C语言编写的函数。
  
  windows中，网络功能是作为标准功能提供的。数据库（数据库服务器）功能有时也会在之后进行追加。网络功能和数据库功能，虽并不是操作系统本身不可欠缺的功能，但因为它们和操作系统很接近，所以被统称为**中间件**而不是应用，意思是处于操作系统和应用的中间。操作系统和中间件合在一起，也称为**系统软件**。相对于操作系统一旦安装就不能轻易替换，中间件则可以根据需要进行任意的替换。
  
  **即插即用**指的是新的设备连接后立刻就可以使用的机制。新的设备连接计算机后，系统需要安装的设定用来控制该设备的**设备驱动程序**。设备驱动是操作系统的一部分，提供了同硬件进行基本的输入输出的功能。键盘、鼠标、显示器、磁盘装置等，这些计算机中必备的硬件的设备驱动一般都是随操作系统一起安装的。如果之后再追加新的硬件，就需要向操作系统追加相应的设备驱动。

### 4：CPU、内存、磁盘

CPU相当于计算机的大脑，负责解释和运行最终转换成机器语言的程序内容。CPU和内存是由许多晶体管组成的电子元件，通常称为IC（集成电路）。**CPU**内部由寄存器、控制器、运算器和时钟四个部分组成。**寄存器**可用来暂存指令、数据等处理对象，可以将其看成内存的一种。**控制器**负责把内存上的指令、数据等读入寄存器，并根据指令的执行结果来控制整个计算机。**运算器**负责运算从内存读入寄存器的数据。**时钟**负责发出CPU开始计时的时钟信号。不过有些计算机的时钟位于CPU外部。

通常说的内存指的是计算机的主存储器（RAM），简称**主存**。主存主要负责存储指令和数据，由可读写的元素构成，每个字节都带有一个地址编号。CPU可以通过地址读写数据。需要注意，主存中存储的指令和数据会随着计算机的关机而自动擦除。另一种内存**ROM**关机或断电后信息不丢失。

![](/assets/img/howProgramWorks/memory.jpg)

在计算机系统中，高速小容量与低速高容量的磁盘进行协同作业。磁盘中存储的程序，必须要加载到内存后才能运行。**磁盘缓存**指的是把从磁盘中读出的数据存储到内存作为缓存，下次需要读取同一数据时就不需要去磁盘读取了。把低速设备的数据保存在高速设备中，需要时可以直接将其从高速设备中读出，这种**缓存**的方式在很多情况下都用到，比如CPU缓存、WEB缓存等等。

**磁盘**是通过把其物理表面划分成多个空间使用的。划分的方式有扇区方式和可变长方式两种。一般windows计算机所使用的硬盘采用的都是扇区方式。扇区方式中，**扇区**是对磁盘进行物理读写的最小单位，一般1个扇区是512字节。不过windows在逻辑方面（软件方面）对磁盘进行读写的单位是扇区整数倍**簇**。根据磁盘容量的不同，1簇可以是1扇区、2扇区等等。以簇为单位进行读写，1簇中没有填满的区域会保持不被使用的状态。

### 5：显示器机制

显示器中显示的信息一直存储在某内存中。该内存成为VRAM（Video RAM）。在程序中，只要往VRAM中写入数据，该数据就会在显示器中显示出来。实现该功能的程序，是由操作系统或BIOS提供，并借助中断来进行处理的。在MS-DOS时代，对大部分计算机来说，VRAM都是主内存的一部分。不过，文字和图形的颜色最多只能有16种。这是因为VRAM得内存空间太小。

现在的计算机中，显卡等专用硬件一般都配置有与主存相独立的**VRAM和GPU**。因为，对经常需要描绘图形的Windows来说，数百兆的VRAM是必须的而为了提升图形的描绘速度，有时还需要专用的图形处理器。

![](/assets/img/howProgramWorks/gpu.jpg)